<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api/routes/cards/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: api/routes/cards/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * CogniCity Server /cards endpoint
 * @module src/api/cards/index
 **/
import {Router} from 'express';

// Import our data model
import cards from './model';

// Import any required utility functions
import {cacheResponse, handleResponse} from '../../../lib/util';

// Import validation dependencies
import Joi from 'joi';
import validate from 'celebrate';

// Import ID generator
import shortid from 'shortid';

// Import image upload capabilities
import AWS from 'aws-sdk';

// Caching
import apicache from 'apicache';
const CACHE_GROUP_CARDS = '/cards';

// Function to clear out the cache
const clearCache = () => {
  apicache.clear(CACHE_GROUP_CARDS);
};

/**
* CogniCity Server /cards endpoint
* @alias module:src/api/cards/index
* @param {Object} config Server configuration
* @param {Object} db PG Promise database instance
* @param {Object} logger Configured Winston logger instance
* @return {Object} api Express router object for cards route
**/
export default ({config, db, logger}) => {
  // Router
  let api = Router(); // eslint-disable-line new-cap

  // Create an S3 object
  let s3 = new AWS.S3(
    {
      accessKeyId: config.AWS_S3_ACCESS_KEY_ID,
      secretAccessKey: config.AWS_S3_SECRET_ACCESS_KEY,
      signatureVersion: config.AWS_S3_SIGNATURE_VERSION,
      region: config.AWS_REGION,
    });

  // Create a new card and if successful return generated cardId
  api.post('/',
    validate({
      body: Joi.object().keys({
        username: Joi.string().required(),
        network: Joi.string().required(),
        language: Joi.string().valid(config.LANGUAGES).required(),
      }),
    }),
    (req, res, next) => {
      let cardId = shortid.generate();
      cards(config, db, logger).create(cardId, req.body)
        .then((data) => data ? res.status(200)
          .json({cardId: cardId, created: true}) :
          next(new Error('Failed to create card')))
        .catch((err) => {
          /* istanbul ignore next */
          logger.error(err);
          /* istanbul ignore next */
          next(err);
        });
    }
  );

  // Check for the existence of a card
  api.head('/:cardId', cacheResponse(config.CACHE_DURATION_CARDS),
    validate({
      params: {cardId: Joi.string().required()},
    }),
    (req, res, next) => {
      req.apicacheGroup = CACHE_GROUP_CARDS;
      cards(config, db, logger).byCardId(req.params.cardId)
        .then((data) => data ? res.status(200).end() : res.status(404).end())
        .catch((err) => {
          /* istanbul ignore next */
          logger.error(err);
          /* istanbul ignore next */
          next(err);
        });
    }
  );

  // Return a card
  api.get('/:cardId', cacheResponse(config.CACHE_DURATION_CARDS),
    validate({
      params: {cardId: Joi.string().min(7).max(14).required()},
    }),
    (req, res, next) => {
      req.apicacheGroup = CACHE_GROUP_CARDS;
      cards(config, db, logger).byCardId(req.params.cardId)
        .then((data) => handleResponse(data, req, res, next))
        .catch((err) => {
          /* istanbul ignore next */
          logger.error(err);
          /* istanbul ignore next */
          next(err);
        });
    }
  );

  // Update a card record with a report
  api.put('/:cardId', validate({
    params: {cardId: Joi.string().min(7).max(14).required()},
    body: Joi.object().keys({
      disaster_type: Joi.string().valid(config.DISASTER_TYPES).required(),
      card_data: Joi.object()
        .keys({
            flood_depth: Joi.number(),
            report_type: Joi.string().valid(config.REPORT_TYPES).required(),
        })
        .required()
        .when('disaster_type', {
            is: 'flood',
            then: Joi.object({flood_depth: Joi.number().integer().min(0)
              .max(200).required()}),    // b.c is required only when a is true
        }),
      text: Joi.string().allow(''),
      image_url: Joi.string().allow(''),
      created_at: Joi.date().iso().required(),
      location: Joi.object().required().keys({
        lat: Joi.number().min(-90).max(90).required(),
        lng: Joi.number().min(-180).max(180).required(),
      }),
    }),
  }),
  (req, res, next) => {
    try {
      // First get the card we wish to update
      cards(config, db, logger).byCardId(req.params.cardId)
        .then((card) => {
          // If the card does not exist then return an error message
          if (!card) {
            res.status(404).json({statusCode: 404, cardId: req.params.cardId,
            message: `No card exists with id '${req.params.cardId}'`});
          } else if (card &amp;&amp; card.received) {
            // If card already has received status then return an error message
            res.status(409).json({statusCode: 409,
            cardId: req.params.cardId, message: `Report already received for '+
              ' card '${req.params.cardId}'`});
          } else {
            // We have a card and it has not yet had a report received
            // Try and submit the report and update the card
            cards(config, db, logger).submitReport(card, req.body)
              .then((data) => {
                clearCache();
                res.status(200).json({statusCode: 200,
                  cardId: req.params.cardId, created: true});
              })
              .catch((err) => {
                /* istanbul ignore next */
                logger.error(err);
                /* istanbul ignore next */
                next(err);
              });
          }
        });
      } catch (err) {
        /* istanbul ignore next */
        logger.error(err);
        /* istanbul ignore next */
        next(err);
      }
    }
  );

  // Gives an s3 signed url for the frontend to upload an image to
  api.get('/:cardId/images', validate({
    params: {cardId: Joi.string().min(7).max(14).required()},
  }),
  (req, res, next) => {
    let s3params = {
      Bucket: config.IMAGES_BUCKET,
      Key: 'originals/' + req.params.cardId + '.jpg',
      ContentType: req.query.file_type,
    };
    s3.getSignedUrl('putObject', s3params, (err, data) => {
      if (err) {
        /* istanbul ignore next */
        logger.error('could not get signed url from S3');
        /* istanbul ignore next */
        logger.error(err);
      } else {
        let returnData = {
          signedRequest: data,
          url: 'https://s3.'+config.AWS_REGION+'.amazonaws.com/'
                + config.IMAGES_BUCKET+'/'+ s3params.Key,
        };
        // write the url into the db under image_url for this card

        cards(config, db, logger).byCardId(req.params.cardId)
          .then((card) => {
            if (!card) {
res.status(404).json({statusCode: 404, cardId: req.params.cardId,
              message: `No card exists with id '${req.params.cardId}'`});
} else {
              // Try and submit the report and update the card
              cards(config, db, logger).updateReport(card,
                {image_url: 'https://'+config.IMAGES_HOST+'/'
                            +req.params.cardId+'.jpg'})
              .then((data) => {
                clearCache();
                logger.debug( 's3 signed request: ' + returnData.signedRequest);
                res.write(JSON.stringify(returnData));
                res.end();
              })
              .catch((err) => {
                /* istanbul ignore next */
                logger.error(err);
                /* istanbul ignore next */
                next(err);
              });
            }
          });
      }
    });
  });

  // Update a card report with new details including the image URL
  api.patch('/:cardId', validate({
    params: {cardId: Joi.string().min(7).max(14).required()},
    body: Joi.object().keys({
      image_url: Joi.string().required(),
    }),
  }),
  (req, res, next) => {
    try {
      // First get the card we wish to update
      cards(config, db, logger).byCardId(req.params.cardId)
        .then((card) => {
          // If the card does not exist then return an error message
          if (!card) {
res.status(404).json({statusCode: 404, cardId: req.params.cardId,
            message: `No card exists with id '${req.params.cardId}'`});
          } else { // We have a card
            // Try and submit the report and update the card
            cards(config, db, logger).updateReport(card, req.body)
              .then((data) => {
                clearCache();
                res.status(200).json({statusCode: 200,
                  cardId: req.params.cardId, updated: true});
              })
              .catch((err) => {
                /* istanbul ignore next */
                logger.error(err);
                /* istanbul ignore next */
                next(err);
              });
          }
        });
      } catch (err) {
        /* istanbul ignore next */
        logger.error(err);
        /* istanbul ignore next */
        next(err);
      }
    }
  );

  return api;
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="db%250ADatabase%2520initializermodule_.html">db
Database initializer</a></li><li><a href="module-lib_cap.html">lib/cap</a></li><li><a href="module-src_api_cards_index.html">src/api/cards/index</a></li><li><a href="module-src_api_cards_model.html">src/api/cards/model</a></li><li><a href="module-src_api_cities_index.html">src/api/cities/index</a></li><li><a href="module-src_api_cities_model.html">src/api/cities/model</a></li><li><a href="module-src_api_feeds_index.html">src/api/feeds/index</a></li><li><a href="module-src_api_feeds_model.html">src/api/feeds/model</a></li><li><a href="module-src_api_floodgauges_index.html">src/api/floodgauges/index</a></li><li><a href="module-src_api_floodgauges_model.html">src/api/floodgauges/model</a></li><li><a href="module-src_api_floods_index.html">src/api/floods/index</a></li><li><a href="module-src_api_floods_model.html">src/api/floods/model</a></li><li><a href="module-src_api_index.html">src/api/index</a></li><li><a href="module-src_api_infrastructure_index.html">src/api/infrastructure/index</a></li><li><a href="module-src_api_infrastructure_model.html">src/api/infrastructure/model</a></li><li><a href="module-src_api_reports_archive_index.html">src/api/reports/archive/index</a></li><li><a href="module-src_api_reports_archive_model.html">src/api/reports/archive/model</a></li><li><a href="module-src_api_reports_index.html">src/api/reports/index</a></li><li><a href="module-src_api_reports_model.html">src/api/reports/model</a></li><li><a href="server%250ACore%2520server%2520modulemodule_.html">server
Core server module</a></li><li><a href="src_test_testCAP%250AA%2520module%2520to%2520test%2520the%2520CAP%2520data%2520format%2520utilitymodule_.html">src/test/testCAP
A module to test the CAP data format utility</a></li><li><a href="src_test_testCards%250AA%2520module%2520to%2520test%2520the%2520_cards%2520endpointmodule_.html">src/test/testCards
A module to test the /cards endpoint</a></li><li><a href="test_testCities%250AA%2520module%2520to%2520test%2520the%2520_cities%2520endpointmodule_.html">test/testCities
A module to test the /cities endpoint</a></li><li><a href="test_testDB%250AA%2520module%2520to%2520test%2520the%2520db%2520utility%2520modulemodule_.html">test/testDB
A module to test the db utility module</a></li><li><a href="test_testFeeds%250AA%2520module%2520to%2520test%2520the%2520_feeds%2520endpointmodule_.html">test/testFeeds
A module to test the /feeds endpoint</a></li><li><a href="test_testFloods%250AA%2520module%2520to%2520test%2520the%2520_floods%2520endpointmodule_.html">test/testFloods
A module to test the /floods endpoint</a></li><li><a href="test_testFloodsgauges%250AA%2520module%2520to%2520test%2520the%2520_floodgauges%2520endpointmodule_.html">test/testFloodsgauges
A module to test the /floodgauges endpoint</a></li><li><a href="test_testInfrastructure%250AA%2520module%2520to%2520test%2520the%2520_infrastructure%2520endpointmodule_.html">test/testInfrastructure
A module to test the /infrastructure endpoint</a></li><li><a href="test_testReports%250AA%2520module%2520to%2520test%2520the%2520_reports%2520endpointmodule_.html">test/testReports
A module to test the /reports endpoint</a></li><li><a href="test_testReportsArchive%250AA%2520module%2520to%2520test%2520the%2520_reports_archive%2520endpointmodule_.html">test/testReportsArchive
A module to test the /reports/archive endpoint</a></li><li><a href="test_testServer%250AA%2520module%2520to%2520test%2520top-level%2520API%2520routes%2520from%2520the%2520servermodule_.html">test/testServer
A module to test top-level API routes from the server</a></li></ul><h3>Classes</h3><ul><li><a href="module-lib_cap.html">lib/cap</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Jun 30 2017 11:48:01 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
