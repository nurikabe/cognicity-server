<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/cap.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/cap.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
/**
 * CogniCity CAP data format utility
 * @module lib/cap
 * @param {Object} logger Configured Winston logger instance
 **/

// XML builder used to create XML output
import builder from 'xmlbuilder';
// moment module, JS date/time manipulation library
import moment from 'moment-timezone';
// Cap class
module.exports = class Cap {
  /**
   * Setup the CAP object to user specified logger
   * @alias module:lib/cap
   * @param {Object} logger Configured Winston logger instance
   */
  constructor(logger) {
    this.logger = logger;
  }
  /**
   * Transform GeoJSON data to ATOM feed of CAP format XML data.
   * See {@link https://tools.ietf.org/html/rfc4287|ATOM syndication format}
   * @param {Object} features Peta Jakarta GeoJSON features object
   * @return {String} XML CAP data describing all areas
   **/
  geoJsonToAtomCap(features) {
    let self = this;
    let feed = {
      '@xmlns': 'http://www.w3.org/2005/Atom',
      'id': 'https://data.petabencana.id/floods',
      'title': 'petabencana.id Flood Affected Areas',
      'updated': moment().tz('Asia/Jakarta').format(),
      'author': {
        name: 'petabencana.id',
        uri: 'https://petabencana.id/',
      },
    };

    for (let feature of features) {
      let alert = self.createAlert( feature );
      // If alert creation failed, don't create the entry
      if (!alert) {
        continue;
      }

      if (!feed.entry) feed.entry = [];

      feed.entry.push({
        // Note, this ID does not resolve to a real resource
        // - but enough information is contained in the URL
        // that we could resolve the flooded report at the same point in time
        id: 'https://data.petabencana.id/floods?parent_name='
        +encodeURI(feature.properties.parent_name)
        +'&amp;area_name='
        +encodeURI(feature.properties.area_name)
        +'&amp;time='
        +encodeURI(moment.tz(feature.properties.last_updated, 'Asia/Jakarta'
                    ).format('YYYY-MM-DDTHH:mm:ssZ')),
        title: alert.identifier + ' Flood Affected Area',
        updated: moment.tz(feature.properties.last_updated, 'Asia/Jakarta'
                    ).format('YYYY-MM-DDTHH:mm:ssZ'),
        content: {
          '@type': 'text/xml',
          'alert': alert,
        },
      });
    }

    return builder.create( {feed: feed} ).end();
  }

  /**
   * Create CAP ALERT object.
   * See {@link `http://docs.oasis-open.org/emergency/cap/v1.2/`
                  + `CAP-v1.2-os.html#_Toc97699527|`
                  + `CAP specification 3.2.1 "alert" Element and Sub-elements`}
   * @param {Object} feature petabencana.id GeoJSON feature
   * @return {Object} Object representing ALERT element for xmlbuilder
   */
  createAlert(feature) {
    let self = this;

    let alert = {};

    alert['@xmlns'] = 'urn:oasis:names:tc:emergency:cap:1.2';

    let identifier = feature.properties.parent_name + '.'
      + feature.properties.area_name + '.'
      + moment.tz(feature.properties.last_updated, 'Asia/Jakarta'
        ).format('YYYY-MM-DDTHH:mm:ssZ');
    identifier = identifier.replace(/ /g, '_');
    alert.identifier = encodeURI(identifier);

    alert.sender = 'BPBD.JAKARTA.GOV.ID';
    alert.sent = moment.tz(feature.properties.last_updated, 'Asia/Jakarta'
                  ).format('YYYY-MM-DDTHH:mm:ssZ');
    alert.status = 'Actual';
    alert.msgType = 'Alert';
    alert.scope = 'Public';

    alert.info = self.createInfo( feature );
    // If info creation failed, don't create the alert
    if (!alert.info) {
      return;
    }

    return alert;
  }

  /**
   * Create a CAP INFO object.
   * See {@link `http://docs.oasis-open.org/emergency/cap/v1.2/`
                  + `CAP-v1.2-os.html#_Toc97699542|`
                  + `CAP specification 3.2.2 "info" Element and Sub-elements`}
   * @param {Object} feature petabencana.id GeoJSON feature
   * @return {Object} Object representing INFO element suitable for xmlbuilder
   */
  createInfo(feature) {
    let self = this;

    let info = {};

    info.category = 'Met';
    info.event = 'FLOODING';
    info.urgency = 'Immediate';

    let severity = '';
    let levelDescription = '';
    if ( feature.properties.state === 1 ) {
      severity = 'Unknown';
      levelDescription = 'AN UNKNOWN LEVEL OF FLOODING - USE CAUTION -';
    } else if ( feature.properties.state === 2 ) {
      severity = 'Minor';
      levelDescription = 'FLOODING OF BETWEEN 10 and 70 CENTIMETERS';
    } else if ( feature.properties.state === 3 ) {
      severity = 'Moderate';
      levelDescription = 'FLOODING OF BETWEEN 71 and 150 CENTIMETERS';
    } else if ( feature.properties.state === 4 ) {
      severity = 'Severe';
      levelDescription = 'FLOODING OF OVER 150 CENTIMETERS';
    } else {
      self.logger.silly('Cap: createInfo(): State '
        + feature.properties.state
        + ' cannot be resolved to a severity');
      return;
    }
    info.severity = severity;

    info.certainty = 'Observed';
    info.senderName = 'JAKARTA EMERGENCY MANAGEMENT AGENCY';
    info.headline = 'FLOOD WARNING';

    let descriptionTime = moment(feature.properties.last_updated
                            ).tz('Asia/Jakarta').format('HH:mm z');
    let descriptionArea = feature.properties.parent_name
                          + ', ' + feature.properties.area_name;
    info.description = 'AT '
                        + descriptionTime
                        + ' THE JAKARTA EMERGENCY MANAGEMENT AGENCY OBSERVED '
                        + levelDescription + ' IN ' + descriptionArea + '.';

    info.web = 'https://petabencana.id/';

    info.area = self.createArea( feature );
    // If area creation failed, don't create the info
    if (!info.area) {
      return;
    }

    return info;
  }

  /**
   * Create a CAP AREA object.
   * See {@link `http://docs.oasis-open.org/emergency/cap/v1.2/`
                + `CAP-v1.2-os.html#_Toc97699550|`
                + `CAP specification 3.2.4 "area" Element and Sub-elements`}
   * @param {Object} feature petabencana.id GeoJSON feature
   * @return {Object} Object representing AREA element for XML xmlbuilder
   */
  createArea(feature) {
    let self = this;

    let area = {};

    area.areaDesc = feature.properties.area_name
                    + ', ' + feature.properties.parent_name;

    // Collate array of polygon-describing strings from different geometry types
    area.polygon = [];
    let featurePolygons;
    if ( feature.geometry.type === 'Polygon' ) {
      featurePolygons = [feature.geometry.coordinates];
    } else if ( feature.geometry.type === 'MultiPolygon' ) {
      featurePolygons = feature.geometry.coordinates;
    } else {
      /* istanbul ignore next */
      self.logger.error( 'Cap: createInfo(): Geometry type \''
                          + feature.geometry.type + '\' not supported' );
      /* istanbul ignore next */
      return;
    }

    // Construct CAP suitable polygon strings
    // (whitespace-delimited WGS84 coordinate pairs - e.g. "lat,lon lat,lon")
    // See: `http://docs.oasis-open.org/emergency/cap/v1.2/`
    //          + `CAP-v1.2-os.html#_Toc97699550 - polygon`
    // See: `http://docs.oasis-open.org/emergency/cap/v1.2/`
    //          + `CAP-v1.2-os.html#_Toc520973440`
    self.logger.debug( 'Cap: createInfo(): '
                        + featurePolygons.length
                        + ' polygons detected for '
                        + area.areaDesc );
    for (let polygonIndex=0; polygonIndex &lt; featurePolygons.length;
      polygonIndex++) {
      // Assume all geometries to be simple Polygons of single LineString
      if ( featurePolygons[polygonIndex].length > 1 ) {
        /* istanbul ignore next */
        self.logger.error( `Cap: createInfo(): Polygon with interior rings is
                            not supported` );
        /* istanbul ignore next */
        return;
      }

      let polygon = '';
      self.logger.debug( 'Cap: createInfo(): '
                        + featurePolygons[polygonIndex][0].length
                        + ' points detected in polygon '
                        + polygonIndex );
      for (let pointIndex=0; pointIndex &lt;
        featurePolygons[polygonIndex][0].length; pointIndex++) {
          let point = featurePolygons[polygonIndex][0][pointIndex];
          polygon += point[1] + ',' + point[0] + ' ';
        }
      area.polygon.push( polygon );
    }

    return area;
  }

};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="db%250ADatabase%2520initializermodule_.html">db
Database initializer</a></li><li><a href="module-lib_cap.html">lib/cap</a></li><li><a href="module-src_api_cards_index.html">src/api/cards/index</a></li><li><a href="module-src_api_cards_model.html">src/api/cards/model</a></li><li><a href="module-src_api_cities_index.html">src/api/cities/index</a></li><li><a href="module-src_api_cities_model.html">src/api/cities/model</a></li><li><a href="module-src_api_feeds_index.html">src/api/feeds/index</a></li><li><a href="module-src_api_feeds_model.html">src/api/feeds/model</a></li><li><a href="module-src_api_floodgauges_index.html">src/api/floodgauges/index</a></li><li><a href="module-src_api_floodgauges_model.html">src/api/floodgauges/model</a></li><li><a href="module-src_api_floods_index.html">src/api/floods/index</a></li><li><a href="module-src_api_floods_model.html">src/api/floods/model</a></li><li><a href="module-src_api_index.html">src/api/index</a></li><li><a href="module-src_api_infrastructure_index.html">src/api/infrastructure/index</a></li><li><a href="module-src_api_infrastructure_model.html">src/api/infrastructure/model</a></li><li><a href="module-src_api_reports_archive_index.html">src/api/reports/archive/index</a></li><li><a href="module-src_api_reports_archive_model.html">src/api/reports/archive/model</a></li><li><a href="module-src_api_reports_index.html">src/api/reports/index</a></li><li><a href="module-src_api_reports_model.html">src/api/reports/model</a></li><li><a href="server%250ACore%2520server%2520modulemodule_.html">server
Core server module</a></li><li><a href="src_test_testCAP%250AA%2520module%2520to%2520test%2520the%2520CAP%2520data%2520format%2520utilitymodule_.html">src/test/testCAP
A module to test the CAP data format utility</a></li><li><a href="src_test_testCards%250AA%2520module%2520to%2520test%2520the%2520_cards%2520endpointmodule_.html">src/test/testCards
A module to test the /cards endpoint</a></li><li><a href="test_testCities%250AA%2520module%2520to%2520test%2520the%2520_cities%2520endpointmodule_.html">test/testCities
A module to test the /cities endpoint</a></li><li><a href="test_testDB%250AA%2520module%2520to%2520test%2520the%2520db%2520utility%2520modulemodule_.html">test/testDB
A module to test the db utility module</a></li><li><a href="test_testFeeds%250AA%2520module%2520to%2520test%2520the%2520_feeds%2520endpointmodule_.html">test/testFeeds
A module to test the /feeds endpoint</a></li><li><a href="test_testFloods%250AA%2520module%2520to%2520test%2520the%2520_floods%2520endpointmodule_.html">test/testFloods
A module to test the /floods endpoint</a></li><li><a href="test_testFloodsgauges%250AA%2520module%2520to%2520test%2520the%2520_floodgauges%2520endpointmodule_.html">test/testFloodsgauges
A module to test the /floodgauges endpoint</a></li><li><a href="test_testInfrastructure%250AA%2520module%2520to%2520test%2520the%2520_infrastructure%2520endpointmodule_.html">test/testInfrastructure
A module to test the /infrastructure endpoint</a></li><li><a href="test_testReports%250AA%2520module%2520to%2520test%2520the%2520_reports%2520endpointmodule_.html">test/testReports
A module to test the /reports endpoint</a></li><li><a href="test_testReportsArchive%250AA%2520module%2520to%2520test%2520the%2520_reports_archive%2520endpointmodule_.html">test/testReportsArchive
A module to test the /reports/archive endpoint</a></li><li><a href="test_testServer%250AA%2520module%2520to%2520test%2520top-level%2520API%2520routes%2520from%2520the%2520servermodule_.html">test/testServer
A module to test top-level API routes from the server</a></li></ul><h3>Classes</h3><ul><li><a href="module-lib_cap.html">lib/cap</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Jun 30 2017 11:48:01 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
