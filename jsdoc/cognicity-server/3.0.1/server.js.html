<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * CogniCity Data Server Module
 * @module server
 * Core server module
 **/
// Import
import Promise from 'bluebird';

// Express middleware and http
import express from 'express';
import http from 'http';

// Import express middlewares
import bodyParser from 'body-parser';
import cors from 'cors';
import compression from 'compression';
import responseTime from 'response-time';
import morgan from 'morgan'; // Express logging

/**
 * @alias module:server
 * @param {Object} config - configuration
 * @param {Object} initializeDb - database initialization
 * @param {Object} routes - routes
 * @param {Object} logger - logger
 * @return {Object} - Express server application
 **/
// Function to initialize the api server
const init = (config, initializeDb, routes, logger) =>
	new Promise((resolve, reject) => {
	// Create the server
	let app = express();
	app.server = http.createServer(app);

	// Winston stream function for express so we can capture logs
	const winstonStream = {
		write: function(message) {
			logger.info(message.slice(0, -1));
		},
	};

	// Setup express logger
	app.use(morgan('combined', {stream: winstonStream}));

	// Compress responses if required but only if caching is disabled
	if (config.COMPRESS &amp;&amp; !config.CACHE) {
		app.use(compression());
	}

	// Provide CORS support (not required if behind API gateway)
	if (config.CORS) {
		app.use(cors({exposedHeaders: config.CORS_HEADERS}));
	}

	// Provide response time header in response
	if (config.RESPONSE_TIME) {
		app.use(responseTime());
	}

	// Parse body messages into json
	app.use(bodyParser.json({limit: config.BODY_LIMIT}));

	// Try and connect to the db
	initializeDb(config, logger)
		.then((db) => {
			// Log debug message
			logger.debug('Successfully connected to DB');

			// Mount the routes
			app.use('/', routes({config, db, logger}));

			// App is ready to go, resolve the promise
			resolve(app);
		})
		.catch((err) => {
			/* istanbul ignore next */
			logger.error('DB Connection error: ' + err);
			/* istanbul ignore next */
			logger.error('Fatal error: Application shutting down');
			/* istanbul ignore next */
			// We cannot continue without a DB, reject
			reject(err);
		});
});

// Export the init function for use externally

module.exports = {init};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="db%250ADatabase%2520initializermodule_.html">db
Database initializer</a></li><li><a href="server%250ACore%2520server%2520modulemodule_.html">server
Core server module</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu Jun 29 2017 15:29:31 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
